flowchart TD
    Start([User Creates Commitment]) --> SetupIntent[Setup Intent: Save Payment Method]
    SetupIntent --> Auth[Calculate Authorization<br/>max_charge_cents]
    Auth --> WeekStart[Week Starts: Monday 12:00 ET]
    
    WeekStart --> TrackUsage[Extension Tracks Daily Usage<br/>Stored in App Group]
    
    TrackUsage --> MondayDeadline{Monday 12:00 ET<br/>Week Deadline}
    
    MondayDeadline --> UserOpensApp{User Opens App?}
    
    UserOpensApp -->|Yes| SyncUsage[UsageSyncManager.syncToBackend]
    UserOpensApp -->|No| WaitForTuesday[Wait for Tuesday 12:00 ET]
    
    SyncUsage --> RpcSync[rpc_sync_daily_usage]
    RpcSync --> CalculatePenalty[Calculate total_penalty_cents<br/>from daily_usage rows]
    CalculatePenalty --> UpdatePenalties[Update user_week_penalties<br/>total_penalty_cents]
    UpdatePenalties --> WaitForTuesday
    
    WaitForTuesday --> TuesdayNoon{Tuesday 12:00 ET<br/>Grace Period Expires}
    
    TuesdayNoon --> RunSettlement[Run: bright-service/run-weekly-settlement]
    
    RunSettlement --> FetchCommitments[Fetch commitments for week]
    FetchCommitments --> ForEachCommitment{For Each Commitment}
    
    ForEachCommitment --> CheckSettled{Already<br/>Settled?}
    CheckSettled -->|Yes| SkipSettled[Skip: alreadySettled++]
    CheckSettled -->|No| CheckUsage{Has Synced<br/>Usage?}
    
    CheckUsage -->|Yes| CheckGrace1{Grace Period<br/>Expired?}
    CheckUsage -->|No| CheckGrace2{Grace Period<br/>Expired?}
    
    CheckGrace1 -->|No| SkipGrace1[Skip: graceNotExpired++]
    CheckGrace1 -->|Yes| ChargeActualPath[Charge Type: actual]
    
    CheckGrace2 -->|No| SkipGrace2[Skip: graceNotExpired++]
    CheckGrace2 -->|Yes| ChargeWorstCasePath[Charge Type: worst_case]
    
    ChargeActualPath --> GetActualAmount[Get actual_penalty_cents<br/>from user_week_penalties]
    GetActualAmount --> CapActual[Cap at max_charge_cents<br/>MIN actual, authorization]
    CapActual --> CreatePaymentIntent1[Create Stripe PaymentIntent<br/>Amount: capped actual]
    CreatePaymentIntent1 --> RecordPayment1[Record Payment<br/>Type: penalty_actual]
    RecordPayment1 --> UpdateStatus1[Update user_week_penalties<br/>Status: charged_actual<br/>charged_amount_cents: capped actual<br/>actual_amount_cents: true actual]
    
    ChargeWorstCasePath --> GetWorstCaseAmount[Get max_charge_cents<br/>from commitment]
    GetWorstCaseAmount --> CreatePaymentIntent2[Create Stripe PaymentIntent<br/>Amount: max_charge_cents]
    CreatePaymentIntent2 --> RecordPayment2[Record Payment<br/>Type: penalty_worst_case]
    RecordPayment2 --> UpdateStatus2[Update user_week_penalties<br/>Status: charged_worst_case<br/>charged_amount_cents: max_charge_cents<br/>actual_amount_cents: 0 unknown]
    
    UpdateStatus1 --> SettlementComplete([Settlement Complete])
    UpdateStatus2 --> SettlementComplete
    SkipSettled --> SettlementComplete
    SkipGrace1 --> SettlementComplete
    SkipGrace2 --> SettlementComplete
    
    SettlementComplete --> NextCommitment{More<br/>Commitments?}
    NextCommitment -->|Yes| ForEachCommitment
    NextCommitment -->|No| CheckLateSync{User Syncs<br/>After Settlement?}
    
    CheckLateSync -->|No| End([End])
    CheckLateSync -->|Yes| LateSync[User Opens App After Tuesday Noon]
    
    LateSync --> LateSyncUsage[UsageSyncManager.syncToBackend]
    LateSyncUsage --> LateRpcSync[rpc_sync_daily_usage]
    LateRpcSync --> LateCalculatePenalty[Calculate total_penalty_cents<br/>from daily_usage rows]
    LateCalculatePenalty --> GetMaxCharge[Get max_charge_cents<br/>from commitment]
    GetMaxCharge --> CapActualLate[Cap actual at authorization<br/>capped_actual = MIN actual, max_charge]
    
    CapActualLate --> CheckSettledStatus{Previous<br/>Settlement<br/>Status?}
    
    CheckSettledStatus -->|Not Settled| NoReconciliation[No Reconciliation Needed<br/>Status: pending]
    CheckSettledStatus -->|charged_actual<br/>charged_worst_case<br/>refunded<br/>refunded_partial| CalculateDelta[Calculate Reconciliation Delta<br/>delta = capped_actual - charged_amount]
    
    CalculateDelta --> CheckDelta{Delta = 0?}
    
    CheckDelta -->|Yes| NoReconciliation
    CheckDelta -->|No| FlagReconciliation[Flag for Reconciliation<br/>needs_reconciliation = true<br/>reconciliation_delta_cents = delta<br/>reconciliation_reason = late_sync_delta]
    
    FlagReconciliation --> RunReconcile[Run: quick-handler/settlement-reconcile]
    RunReconcile --> FetchCandidates[Fetch reconciliation candidates<br/>needs_reconciliation = true]
    FetchCandidates --> ForEachCandidate{For Each Candidate}
    
    ForEachCandidate --> CheckDeltaSign{Delta < 0?}
    
    CheckDeltaSign -->|Yes| RefundPath[Refund Path]
    CheckDeltaSign -->|No| ChargePath[Extra Charge Path]
    
    RefundPath --> CheckPaymentIntent{Has charge_payment_intent_id?}
    CheckPaymentIntent -->|No| SkipRefund[Skip: missing_payment_intent]
    CheckPaymentIntent -->|Yes| CreateRefund[Create Stripe Refund<br/>Amount: abs delta]
    CreateRefund --> UpdateRefund[Update user_week_penalties<br/>Status: refunded or refunded_partial<br/>refund_amount_cents += abs delta<br/>charged_amount_cents -= abs delta<br/>needs_reconciliation = false]
    UpdateRefund --> RecordRefundPayment[Record Payment<br/>Type: penalty_refund]
    
    ChargePath --> CheckCustomer{Has Stripe<br/>Customer?}
    CheckCustomer -->|No| SkipCharge1[Skip: missing_stripe_customer]
    CheckCustomer -->|Yes| CheckPaymentMethod{Has Payment<br/>Method?}
    CheckPaymentMethod -->|No| SkipCharge2[Skip: missing_payment_method]
    CheckPaymentMethod -->|Yes| CheckUnderCap{Delta > 0 AND<br/>charged + delta <=<br/>authorization?}
    CheckUnderCap -->|No: At Cap| NoExtraCharge[No Extra Charge<br/>Already at authorization cap]
    CheckUnderCap -->|Yes: Under Cap| CreateCharge[Create Stripe PaymentIntent<br/>Amount: delta]
    CreateCharge --> UpdateCharge[Update user_week_penalties<br/>Status: charged_actual_adjusted<br/>charged_amount_cents += delta<br/>needs_reconciliation = false]
    UpdateCharge --> RecordChargePayment[Record Payment<br/>Type: penalty_adjustment]
    
    RecordRefundPayment --> ReconciliationDone([Reconciliation Complete])
    RecordChargePayment --> ReconciliationDone
    SkipRefund --> ReconciliationDone
    SkipCharge1 --> ReconciliationDone
    SkipCharge2 --> ReconciliationDone
    NoExtraCharge --> ReconciliationDone
    NoReconciliation --> ReconciliationDone
    
    ReconciliationDone --> NextCandidate{More<br/>Candidates?}
    NextCandidate -->|Yes| ForEachCandidate
    NextCandidate -->|No| End
    
    style Start fill:#e1f5ff
    style End fill:#d4edda
    style SettlementComplete fill:#d4edda
    style ReconciliationDone fill:#d4edda
    style ChargeActualPath fill:#fff3cd
    style ChargeWorstCasePath fill:#f8d7da
    style CapActual fill:#ffeaa7
    style CapActualLate fill:#ffeaa7
    style RefundPath fill:#d1ecf1
    style ChargePath fill:#f8d7da
    style CheckDeltaSign fill:#fff3cd
    style NoExtraCharge fill:#ffeaa7
    style CheckUnderCap fill:#ffeaa7


